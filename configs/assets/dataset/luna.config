import numpy as np

from dpipe.dataset.wrappers import apply, cache_methods
from ood.dataset.luna import LUNA16, get_n_tumors
from ood.dataset.utils import Rescale3D, scale_ct, CropToLungs


# if `voxel_spacing[i]` is `None` when `i`-th dimension will be used without scaling
voxel_spacing = (1., 1., 1.5)
max_cache_size = 810

preprocessed_dataset = apply(Rescale3D(CropToLungs(LUNA16(), dataset_name='lidc'), voxel_spacing, order=1),
                             load_image=scale_ct)

# preprocessed_dataset = apply(Rescale3D(LUNA16(), voxel_spacing, order=1), load_image=scale_ct)

dataset = apply(
    cache_methods(apply(preprocessed_dataset, load_image=np.float16, load_segm=np.bool_), maxsize=max_cache_size),
    load_image=np.float32, load_segm=np.float32)

n_tumors = get_n_tumors(dataset, train_ids)
