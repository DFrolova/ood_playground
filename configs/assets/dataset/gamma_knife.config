import numpy as np

from dpipe.dataset.wrappers import apply, cache_methods
from ood.dataset.gamma_knife import GammaKnife, Rescale3D, RotateImage
from ood.dataset.utils import scale_mri
from ood.paths import GAMMA_KNIFE_MET_T1_T1C_PATH, GAMMA_KNIFE_BRAIN_PATH


data_path_met = GAMMA_KNIFE_MET_T1_T1C_PATH
data_path_brain = GAMMA_KNIFE_BRAIN_PATH

# if `voxel_spacing[i]` is `None` when `i`-th dimension will be used without scaling
# voxel_spacing = (None, None, None)
voxel_spacing = (1, 0.95, 0.95)  # as in CC359; the original GK spacing is close to the CC359 spacing.

preprocessed_dataset = apply(RotateImage(Rescale3D(GammaKnife(data_path_met, 'metadata_30Oct2021.csv', 'SeriesInstanceUID'), 
                                                   voxel_spacing)), load_image=scale_mri, load_t1_image=scale_mri)
dataset = apply(preprocessed_dataset, load_image=np.float32, load_t1_image=np.float32)

preprocessed_dataset_brain = apply(RotateImage(Rescale3D(GammaKnife(data_path_brain, 'meta.csv'), 
                                                         voxel_spacing)), load_image=scale_mri, load_t1_image=scale_mri)
dataset_brain = apply(preprocessed_dataset_brain, load_image=np.float32, load_t1_image=np.float32)

# for t1
load_y = dataset.load_t1_image